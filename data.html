<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LaggyWorld - Dashboard</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="banner-header">
    <img src="your-banner.jpg" alt="LaggyWorld Banner" class="banner-img">
    <div class="user-header">
      <img id="pfp" src="https://via.placeholder.com/64" alt="PFP" class="profile-pic">
      <div>
        <h2 id="username">Loading...</h2>
        <p class="level">Level 1 ‚Äì Newbie</p>
      </div>
      <span class="status online">‚óè Online</span>
    </div>
    <div class="header-buttons">
      <button>Widgets</button>
      <button>Profile</button>
      <button>My Content</button>
    </div>
  </header>

  <main class="dashboard-grid">
    <section class="dashboard-box">
      <h3>üíé Diamonds</h3>
      <p>When you give diamonds to content, they will be listed here.</p>
      <button class="view-btn">View All Content</button>
    </section>

    <section class="dashboard-box">
      <h3>‚ù§Ô∏è Favorites</h3>
      <select>
        <option>Most Recent Favorites</option>
        <option>Oldest Favorites</option>
      </select>
      <div class="favorite-card" id="favorites">
        <p>Loading favorites...</p>
      </div>
      <button class="view-btn">View All Favorites</button>
    </section>

    <section class="dashboard-box full-width">
      <h3>üåê Supporting Site</h3>
      <p>No linked site yet.</p>
    </section>
  </main>

  <footer>
    <button onclick="logout()">Logout</button>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, updateEmail, updatePassword } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    const firebaseConfig = {
      // ‚úÖ Replace with your actual Firebase config
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const pfp = document.getElementById("pfp");
    const usernameSpan = document.getElementById("username");
    const emailSpan = document.getElementById("email");
    const pfpUpload = document.getElementById("pfpUpload");
    const bgUpload = document.getElementById("bgUpload");
    const planSection = document.getElementById("planSection");

    onAuthStateChanged(auth, async (user) => {
      if (!user) return (window.location.href = "login.html");

      const userRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(userRef);
      const userData = userSnap.data();

      const defaultPfp = "https://via.placeholder.com/100";
      pfp.src = userData.pfpUrl || defaultPfp;
      usernameSpan.textContent = userData.username || "No username";
      emailSpan.textContent = user.email;

      if (userData.bgUrl) {
        document.body.style.backgroundImage = `url(${userData.bgUrl})`;
        document.body.style.backgroundSize = "cover";
      }

      if (userData.plan) {
        planSection.innerHTML = `<p><strong>Plan:</strong> ${userData.plan}</p><a href="dashboard.html">Go to Hosting Dashboard</a>`;
      }

      const serversRef = query(collection(db, "servers"), where("owner", "==", user.uid));
      const serversSnap = await getDocs(serversRef);
      const serversDiv = document.getElementById("servers");

      if (serversSnap.empty) {
        serversDiv.innerHTML = "<p>You have no servers yet.</p>";
      } else {
        let html = "<ul>";
        serversSnap.forEach(doc => {
          const server = doc.data();
          html += `<li><strong>${server.name}</strong> ‚Äì ${server.status || "offline"}</li>`;
        });
        html += "</ul>";
        serversDiv.innerHTML = html;
      }

      // Upload PFP
      pfpUpload.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const pfpRef = ref(storage, `pfps/${user.uid}`);
        await uploadBytes(pfpRef, file);
        const url = await getDownloadURL(pfpRef);

        await updateDoc(userRef, { pfpUrl: url });
        pfp.src = url;
        alert("Profile picture updated!");
      });

      // Upload BG
      bgUpload.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const bgRef = ref(storage, `backgrounds/${user.uid}`);
        await uploadBytes(bgRef, file);
        const url = await getDownloadURL(bgRef);

        await updateDoc(userRef, { bgUrl: url });
        document.body.style.backgroundImage = `url(${url})`;
        alert("Background updated!");
      });
    });
    window.changeUsername = async () => {
      const newUsername = document.getElementById("newUsername").value.trim();
      if (!newUsername) return alert("Username required.");
      const user = auth.currentUser;
      await updateDoc(doc(db, "users", user.uid), { username: newUsername });
      alert("Username updated!");
      usernameSpan.textContent = newUsername;
    };

    // üìß Update Email
    window.changeEmail = async () => {
      const newEmail = document.getElementById("newEmail").value.trim();
      if (!newEmail) return alert("Email required.");
      try {
        await updateEmail(auth.currentUser, newEmail);
        await updateDoc(doc(db, "users", auth.currentUser.uid), { email: newEmail });
        alert("Email updated!");
        emailSpan.textContent = newEmail;
      } catch (e) {
        alert("Failed to update email: " + e.message);
      }
    };

    window.changePassword = async () => {
      const newPassword = document.getElementById("newPassword").value.trim();
      if (!newPassword || newPassword.length < 6) return alert("Password too short.");
      try {
        await updatePassword(auth.currentUser, newPassword);
        alert("Password updated!");
      } catch (e) {
        alert("Failed to update password: " + e.message);
      }
    };

    window.logout = () => {
      signOut(auth).then(() => window.location.href = "login.html");
    };
  </script>
</body>
</html>
